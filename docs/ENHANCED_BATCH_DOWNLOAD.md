# 增强批量下载功能说明

## 🎯 新增功能概述

本次优化为Docker镜像同步工具添加了两个重要的增强功能：

1. **智能推送脚本生成** - 批量下载时自动生成可配置的推送脚本
2. **自动清理机制** - 默认保留1天文件，避免磁盘空间占用过大

## 📥 增强批量下载功能

### 功能特性

#### 🔧 智能推送脚本生成
- ✅ **自动生成**：批量下载时同时生成对应的推送脚本
- ✅ **参数化配置**：支持命令行参数指定目标仓库、认证信息等
- ✅ **完整流程**：包含加载、重新标记、推送的完整镜像处理流程
- ✅ **错误处理**：智能的错误检测和恢复机制
- ✅ **模拟运行**：支持`--dry-run`模式预览操作

#### 🎯 目标仓库配置
- ✅ **仓库选择**：从已配置的私服列表中选择
- ✅ **自定义仓库**：支持手动输入任意仓库地址
- ✅ **可选配置**：可以选择不指定目标仓库，仅下载文件

### 使用流程

1. **选择文件**：在文件管理界面勾选要下载的文件
2. **配置目标**：点击"批量下载选中项"，选择目标仓库（可选）
3. **开始处理**：系统自动打包文件并生成推送脚本
4. **下载文件**：分别下载zip压缩包和推送脚本

### 界面截图

```
┌─────────────────────────────────────────────────────────────────┐
│ 批量下载配置 (2 个文件)                                    ❌   │
├─────────────────────────────────────────────────────────────────┤
│ ℹ️ 选择目标仓库将自动生成推送脚本，可用于将镜像重新标记并推送到指定仓库。  │
│                                                                 │
│ 📋 选中的文件：           🖥️ 目标仓库配置：                      │
│ • nginx.tar              选择目标仓库 (可选)                    │
│ • redis.tar              [下拉菜单: Harbor私服]                 │
│                          💡 提示：                              │
│                          • 不选择仓库：仅打包下载文件           │
│                          • 选择仓库：额外生成推送脚本           │
│                          • 推送脚本支持命令行参数配置           │
├─────────────────────────────────────────────────────────────────┤
│                           [取消]  [开始打包下载] 📥             │
└─────────────────────────────────────────────────────────────────┘
```

## 📜 推送脚本功能

### 脚本特性

#### 🛠️ 命令行参数支持
```bash
# 基本使用
./batch_push_*.sh -r harbor.example.com -n library -u admin -p password

# 高级选项
./batch_push_*.sh --registry harbor.example.com \
                  --namespace myproject \
                  --username admin \
                  --password mypass \
                  --dry-run    # 模拟运行
```

#### 📋 完整参数列表
| 参数 | 说明 | 示例 |
|------|------|------|
| `-r, --registry` | 目标仓库地址 | `harbor.example.com` |
| `-n, --namespace` | 目标命名空间 | `library`, `myproject` |
| `-u, --username` | 仓库用户名 | `admin` |
| `-p, --password` | 仓库密码 | `mypassword` |
| `--no-push` | 只加载标记，不推送 | 用于离线环境 |
| `--dry-run` | 模拟运行，不实际执行 | 预览操作 |
| `-h, --help` | 显示帮助信息 | |

### 脚本流程

#### 🔄 完整处理流程
1. **参数验证**：检查必需参数和Docker环境
2. **仓库登录**：自动登录到目标仓库（如果提供认证信息）
3. **文件处理**：逐个处理每个tar文件
   - 加载镜像：`docker load < filename.tar`
   - 提取信息：智能解析镜像ID和名称
   - 重新标记：`docker tag source target_registry/namespace/image`
   - 推送镜像：`docker push target_registry/namespace/image`
4. **状态汇总**：显示成功/失败统计
5. **清理工作**：自动登出和清理临时数据

#### 🎨 彩色输出
- 🔵 **蓝色 [INFO]**：信息提示
- 🟢 **绿色 [SUCCESS]**：操作成功
- 🟡 **黄色 [WARNING]**：警告信息
- 🔴 **红色 [ERROR]**：错误信息

### 使用示例

#### 基本推送到Harbor
```bash
./batch_push_*.sh -r harbor.example.com -n library -u admin -p Harbor12345
```

#### 推送到阿里云ACR
```bash
./batch_push_*.sh -r registry.cn-hangzhou.aliyuncs.com \
                  -n mynamespace \
                  -u myuser \
                  -p mypassword
```

#### 仅加载不推送（离线环境）
```bash
./batch_push_*.sh --no-push
```

#### 模拟运行（预览操作）
```bash
./batch_push_*.sh -r harbor.example.com -n library --dry-run
```

## 🧹 自动清理机制

### 清理策略

#### ⏰ 默认配置
- **保留时间**：1天（24小时）
- **检查频率**：每6小时自动检查一次
- **清理范围**：downloads目录下的所有文件

#### 🔧 清理触发
- **自动触发**：应用启动时立即执行一次，之后每6小时执行
- **手动触发**：通过Web界面的"自动清理"按钮
- **API触发**：通过`/api/files/auto-cleanup`接口

### 清理日志

```bash
[INFO] 开始自动清理下载目录中的旧文件...
[DEBUG] 已删除过期文件: old_file_1.tar (已存在25.3小时)
[DEBUG] 已删除过期文件: old_file_2.zip (已存在30.1小时)
[INFO] 自动清理完成，删除了 2 个过期文件
```

### 安全特性

- ✅ **路径验证**：确保只清理downloads目录内的文件
- ✅ **时间检查**：精确的文件年龄计算
- ✅ **错误处理**：清理失败不影响应用运行
- ✅ **日志记录**：详细的操作日志便于排查

## 🔧 API接口说明

### 增强批量下载API

**端点**：`POST /api/files/batch-download`

**请求参数**：
```json
{
    "filenames": ["file1.tar", "file2.tar"],
    "target_registry": "harbor.example.com"  // 可选
}
```

**响应数据**：
```json
{
    "zip_filename": "batch_download_abc123_20240524_185258.zip",
    "download_url": "/downloads/batch_download_abc123_20240524_185258.zip",
    "included_files": ["file1.tar", "file2.tar"],
    "file_count": 2,
    "script": {
        "filename": "batch_push_def456_20240524_185258.sh",
        "download_url": "/downloads/batch_push_def456_20240524_185258.sh",
        "target_registry": "harbor.example.com"
    }
}
```

### 自动清理API

**端点**：`POST /api/files/auto-cleanup`

**响应数据**：
```json
{
    "success": true,
    "message": "自动清理已在后台启动，请稍后查看日志"
}
```

## 🛡️ 安全与性能

### 安全特性

- ✅ **认证检查**：所有API都需要用户登录
- ✅ **路径验证**：防止目录遍历攻击
- ✅ **参数验证**：严格的输入参数检查
- ✅ **临时文件管理**：自动清理失败的临时文件

### 性能优化

- ✅ **后台处理**：清理操作在后台线程中执行
- ✅ **智能调度**：使用schedule库进行精确的时间调度
- ✅ **资源管理**：及时释放文件句柄和内存
- ✅ **错误恢复**：清理失败不影响主要功能

## 📊 使用统计

### 功能对比

| 功能 | 优化前 | 优化后 |
|------|--------|--------|
| 批量下载 | ✅ zip打包 | ✅ zip打包 + 推送脚本 |
| 目标仓库配置 | ❌ 不支持 | ✅ 可选配置 |
| 命令行参数 | ❌ 不支持 | ✅ 完整支持 |
| 文件清理 | 🔧 手动清理 | ✅ 自动+手动 |
| 磁盘管理 | ⚠️ 手动管理 | ✅ 自动保留1天 |

### 用户体验提升

- 🚀 **效率提升**：一键生成可直接使用的推送脚本
- 🎯 **操作简化**：图形界面配置，命令行执行
- 🛡️ **安全增强**：参数化配置避免硬编码密码
- 🧹 **维护便利**：自动清理避免磁盘空间问题

## 🎉 总结

通过这次增强优化，Docker镜像同步工具现在提供了：

1. **🔄 完整的镜像处理流程**：从下载到推送的一站式解决方案
2. **⚙️ 灵活的配置选项**：支持多种仓库和部署环境
3. **🤖 智能的自动化**：减少手动维护工作
4. **🛡️ 企业级的安全**：参数化配置和权限控制
5. **📊 友好的用户体验**：直观的界面和详细的反馈

这些功能使得工具更适合生产环境使用，能够有效解决镜像批量处理和磁盘空间管理的痛点。 